<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Code Config - å¯è§†åŒ–é…ç½®ç®¡ç†å™¨</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #18181b;
      --primary-light: #3f3f46;
      --primary-dark: #000000;
      --primary-bg: #f4f4f5;
      --secondary: #52525b;
      --danger: #ef4444;
      --danger-bg: #fef2f2;
      --success: #22c55e;
      --success-bg: #f0fdf4;
      --warning: #f59e0b;
      --warning-bg: #fffbeb;
      --text-primary: #18181b;
      --text-secondary: #71717a;
      --text-muted: #a1a1aa;
      --bg-primary: #fafafa;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f4f4f5;
      --sidebar-bg: #ffffff;
      --border: #e4e4e7;
      --border-light: #f4f4f5;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.03);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --radius-xl: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      display: flex;
    }

    /* ä¾§è¾¹æ å¸ƒå±€ */
    .app-layout {
      display: flex;
      width: 100%;
      min-height: 100vh;
    }

    .sidebar {
      width: 260px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      z-index: 10;
    }

    .sidebar-header {
      padding: 24px 24px 32px;
    }

    .sidebar-header h1 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-header h1::before {
      content: '';
      display: block;
      width: 20px;
      height: 20px;
      background: var(--primary);
      border-radius: 4px;
    }

    .nav-menu {
      flex: 1;
      padding: 0 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      padding: 10px 12px;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--bg-tertiary);
      color: var(--primary);
      font-weight: 600;
      border-color: var(--border);
    }

    .nav-item svg {
      width: 18px;
      height: 18px;
      stroke-width: 1.5;
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ä¸»å†…å®¹åŒºåŸŸ */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 40px;
      max-width: 1000px;
    }

    .page-header {
      margin-bottom: 32px;
    }

    .page-title {
      font-size: 24px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .page-desc {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .skills-section-header {
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .skills-section-header .btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-weight: 500;
      padding: 0;
      box-shadow: none;
      min-width: auto;
    }

    .skills-section-header .btn:hover {
      background: transparent;
      color: var(--primary);
    }

    .skills-intro-card {
      background: linear-gradient(135deg, var(--primary) 0%, #27272a 100%);
      color: white;
      border-radius: var(--radius-xl);
      padding: 24px;
      margin-bottom: 32px;
      box-shadow: var(--shadow-lg);
    }

    .skills-intro-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .skills-intro-text {
      font-size: 14px;
      line-height: 1.6;
      opacity: 0.9;
    }

    .skill-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .skill-card:hover {
      border-color: var(--text-muted);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .skill-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .skill-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .skill-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
    }

    .skill-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .skill-desc {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .skill-status-badge {
      font-size: 12px;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 100px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .skill-status-badge.installed {
      background: var(--success-bg);
      color: var(--success);
    }

    .skill-status-badge.not-installed {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    /* ä¼˜åŒ–åçš„è¡¨æ ¼æ ·å¼ */
    .stats-table th {
      background: transparent;
      border-bottom: 1px solid var(--border);
      padding: 16px;
    }

    .stats-table td {
      padding: 16px;
    }

    .stats-table-wrapper {
      box-shadow: none;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* ä¼˜åŒ–åçš„å½“å‰çŠ¶æ€æ ·å¼ */
    .status-card {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 24px;
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      overflow: hidden;
    }

    .status-info {
      flex: 1;
    }

    .status-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 0 4px var(--success-bg);
    }

    .status-dot.inactive {
      background: var(--text-muted);
      box-shadow: none;
    }

    /* ä¼˜åŒ–åçš„å¡ç‰‡æ ·å¼ */
    .profile-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 16px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .profile-card:last-child {
      margin-bottom: 0;
    }

    .profile-card:hover {
      border-color: var(--text-muted);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .profile-card.active {
      border-color: var(--primary);
      background: var(--bg-secondary);
      box-shadow: 0 0 0 1px var(--primary);
    }

    .profile-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .profile-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .profile-model {
      font-size: 12px;
      font-weight: 400;
      color: var(--text-secondary);
      background: var(--bg-tertiary);
      padding: 2px 8px;
      border-radius: 100px;
    }

    .profile-actions {
      display: flex;
      gap: 8px;
      opacity: 0.8;
      transition: opacity 0.2s;
    }

    .profile-card:hover .profile-actions {
      opacity: 1;
    }

    /* æŒ‰é’®æ ·å¼å¾®è°ƒ */
    .btn {
      padding: 8px 16px;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 500;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      cursor: pointer;
    }

    /* ç»Ÿä¸€æ“ä½œæŒ‰é’®å®½åº¦ */
    .btn-secondary,
    .btn-primary,
    .btn-danger-ghost {
      min-width: 80px;
    }

    /* ä½†ä¸éœ€è¦å›ºå®šå®½åº¦çš„ç‰¹å®šæŒ‰é’®é™¤å¤– */
    #btn-install-all,
    #btn-uninstall-all,
    .modal-actions .btn,
    .skills-section-header .btn {
      min-width: auto;
    }

    .btn-icon-only {
        width: 32px;
        padding: 0;
    }

    .btn-edit {
        color: var(--text-secondary);
        background: transparent;
        border: 1px solid transparent;
    }

    .btn-edit:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .btn-danger-ghost {
        color: var(--danger);
        background: transparent;
        border: 1px solid transparent;
    }

    .btn-danger-ghost:hover {
        background: var(--danger-bg);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
      background: var(--bg-tertiary);
      border-radius: var(--radius-lg);
      font-size: 13px;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-overlay.show { display: flex; }

    .modal {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: 32px;
      width: 90%;
      max-width: 480px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
    }

    .modal h2 {
      margin-bottom: 24px;
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-group { margin-bottom: 20px; }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .form-group input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 14px;
      font-family: inherit;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.15s;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-bg);
    }

    .form-group input::placeholder {
      color: var(--text-muted);
    }

    .form-hint {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .notification {
      position: fixed;
      top: 24px;
      right: 24px;
      background: var(--text-primary);
      color: white;
      padding: 14px 20px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: 2000;
      transform: translateX(120%);
      transition: transform 0.3s;
      font-weight: 500;
      font-size: 14px;
    }

    .notification.show { transform: translateX(0); }
    .notification.success { background: var(--success); }
    .notification.error { background: var(--danger); }
    .notification.info { background: #3b82f6; }

    .reload-tip {
      background: var(--success-bg);
      border-left: 3px solid var(--success);
      padding: 14px 16px;
      margin-top: 16px;
      border-radius: var(--radius-md);
      font-size: 14px;
      color: #166534;
    }

    .setup-tip {
      background: #fef3c7;
      border-left: 3px solid var(--warning);
      padding: 16px;
      margin-top: 16px;
      border-radius: var(--radius-md);
      font-size: 14px;
      color: #78350f;
    }

    .setup-tip strong {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .setup-tip code {
      background: rgba(255,255,255,0.7);
      padding: 3px 8px;
      border-radius: var(--radius-sm);
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
    }

    .setup-tip p {
      margin: 6px 0;
      line-height: 1.6;
    }

    /* Tokenç»Ÿè®¡é¢æ¿æ ·å¼ */
    .stats-section {
      margin-top: 32px;
      padding-top: 32px;
      border-top: 1px solid var(--border);
    }

    .stats-summary {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      padding: 16px;
      border: 1px solid var(--border);
      text-align: center;
    }

    .stat-card .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 6px;
    }

    .stat-card .stat-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--primary);
    }

    .stats-table-wrapper {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
    }

    .stats-table th,
    .stats-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .stats-table th {
      background: var(--bg-tertiary);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .stats-table td {
      font-size: 14px;
      color: var(--text-primary);
    }

    .stats-table tr:last-child td {
      border-bottom: none;
    }

    .stats-table tr:hover {
      background: var(--bg-primary);
    }

    .token-number {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
    }

    .token-input { color: var(--primary); }
    .token-output { color: var(--secondary); }
    .token-total { color: var(--text-primary); font-weight: 600; }

    .stats-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .empty-stats {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .model-badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      background: var(--bg-tertiary);
      border-radius: 100px;
      font-size: 12px;
      font-weight: 500;
    }

    /* é…ç½®çŠ¶æ€æ£€æµ‹é¢æ¿æ ·å¼ */
    .config-status-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 24px;
    }

    .config-status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .config-status-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .config-status-content {
      min-height: 40px;
    }

    .status-loading {
      color: var(--text-secondary);
      font-size: 13px;
    }

    .conflict-error {
      background: var(--danger-bg);
      border-left: 4px solid var(--danger);
      padding: 16px;
      border-radius: var(--radius-md);
      margin-bottom: 12px;
    }

    .conflict-warning {
      background: var(--warning-bg);
      border-left: 4px solid var(--warning);
      padding: 16px;
      border-radius: var(--radius-md);
      margin-bottom: 12px;
    }

    .conflict-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .conflict-icon {
      font-size: 20px;
    }

    .conflict-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
    }

    .conflict-message {
      color: var(--text-primary);
      font-size: 13px;
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .conflict-code {
      background: rgba(0,0,0,0.08);
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      margin: 8px 0;
      overflow-x: auto;
    }

    .status-ok {
      background: var(--success-bg);
      border-left: 4px solid var(--success);
      padding: 16px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-icon {
      font-size: 20px;
    }

    .status-message {
      color: #166534;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      body {
        display: block;
        padding: 0;
      }

      .app-layout {
        flex-direction: column;
        display: block;
      }

      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        border-right: none;
        border-bottom: 1px solid var(--border);
        flex-direction: row;
        align-items: center;
        padding: 0 16px;
        top: 0;
        z-index: 100;
        background: var(--sidebar-bg);
      }

      .sidebar-header {
        padding: 16px 0;
        width: auto;
        margin-right: 24px;
      }

      .nav-menu {
        flex-direction: row;
        flex: 1;
        overflow-x: auto;
        padding: 0;
        gap: 8px;
        align-items: center;
        height: 100%;
        -webkit-overflow-scrolling: touch;
      }

      .nav-item {
        white-space: nowrap;
        padding: 8px 12px;
        font-size: 13px;
        flex-shrink: 0;
      }

      .sidebar-footer {
        display: none;
      }

      .main-content {
        margin-left: 0;
        padding: 24px 16px;
        max-width: 100%;
      }

      .page-title {
        font-size: 20px;
      }

      /* Profileå¡ç‰‡å“åº”å¼ */
      .profile-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      .profile-actions {
        width: 100%;
        justify-content: space-between;
      }

      .profile-actions .btn {
        flex: 1;
        justify-content: center;
      }

      .section-title {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }

      .section-title .btn {
        width: 100%;
        justify-content: center;
      }

      /* ç»Ÿè®¡æ‘˜è¦å“åº”å¼ */
      .stats-summary {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .stat-card {
        padding: 12px;
      }

      .stat-card .stat-value {
        font-size: 18px;
      }

      .stats-table-wrapper {
        overflow-x: auto;
        border-radius: var(--radius-md);
      }

      .stats-table {
        min-width: 600px;
      }

      .modal {
        padding: 24px;
        width: 90%;
      }
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>Claude API</h1>
      </div>

      <nav class="nav-menu">
        <a class="nav-item active" onclick="switchTab('profiles')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <rect x="7" y="7" width="3" height="9"></rect>
            <rect x="14" y="7" width="3" height="5"></rect>
          </svg>
          APIé…ç½®
        </a>
        <a class="nav-item" onclick="switchTab('skills')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
            <polyline points="2 17 12 22 22 17"></polyline>
            <polyline points="2 12 12 17 22 12"></polyline>
          </svg>
          Skills ç®¡ç†
        </a>
        <a class="nav-item" onclick="switchTab('mcp')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
             <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
          </svg>
          MCP Servers
        </a>
        <a class="nav-item" onclick="switchTab('stats')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
          </svg>
          Token ç»Ÿè®¡
        </a>
      </nav>

      <div class="sidebar-footer">
        ç‰ˆæœ¬ 1.0.0
      </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
      <!-- é…ç½®æ–¹æ¡ˆæ ‡ç­¾é¡µ -->
      <div class="tab-content active" id="tab-profiles">
        <div class="page-header">
          <h2 class="page-title">APIé…ç½®</h2>
          <p class="page-desc">ç®¡ç†å’Œåˆ‡æ¢ä¸åŒçš„ API é…ç½®ç»„åˆ</p>
        </div>

        <div class="status-card">
          <div class="status-info">
            <div class="status-label">å½“å‰çŠ¶æ€</div>
            <div class="status-value">
              <span id="currentStatus">åŠ è½½ä¸­...</span>
              <div id="statusDot" class="status-dot"></div>
            </div>
          </div>

          <div class="status-actions">
            <!-- è¿™é‡Œå¯ä»¥æ”¾ä¸€äº›å…¨å±€æ“ä½œæŒ‰é’®ï¼Œå¦‚æœéœ€è¦çš„è¯ -->
          </div>
        </div>

        <!-- é…ç½®çŠ¶æ€æ£€æµ‹é¢æ¿ -->
        <div class="config-status-card">
          <div class="config-status-header">
            <div class="config-status-title">é…ç½®çŠ¶æ€æ£€æµ‹</div>
            <button class="btn btn-secondary" onclick="checkConfigStatus()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-right: 4px;">
                <path d="M23 4v6h-6"></path>
                <path d="M1 20v-6h6"></path>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
              åˆ·æ–°æ£€æµ‹
            </button>
          </div>
          <div id="configStatusContent" class="config-status-content">
            <div class="status-loading">æ£€æµ‹ä¸­...</div>
          </div>
        </div>

        <!-- é‡å¯æç¤º -->
        <div class="reload-tip" id="restartTip" style="display: none; margin-bottom: 32px;">
          é…ç½®å·²ä¿®å¤ï¼Œè¯·åœ¨ç»ˆç«¯æ‰§è¡Œ <code>source ~/.zshrc</code> é‡æ–°åŠ è½½é…ç½®
        </div>

        <div class="reload-tip" id="reloadTip" style="display: none; margin-bottom: 32px;">
          é…ç½®å·²æ¿€æ´»ï¼Œç°åœ¨å¯ä»¥ç›´æ¥ä½¿ç”¨ claude å‘½ä»¤
        </div>

        <div class="setup-tip" id="setupTip" style="display: none; margin-bottom: 32px;">
            <strong>é¦–æ¬¡ä½¿ç”¨éœ€è¦ä¸€é”®å®‰è£…</strong>
            <p>åœ¨ç»ˆç«¯è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
            <code>cd /Users/shawn/Documents/ClaudeCode/claude-api-config && bash setup.sh && source ~/.zshrc</code>
            <p>å®‰è£…åï¼Œæ¯æ¬¡åœ¨ç½‘é¡µç‚¹å‡»æ¿€æ´»ï¼Œç›´æ¥ä½¿ç”¨ claude å‘½ä»¤å³å¯ï¼Œæ— éœ€å…¶ä»–æ“ä½œ</p>
        </div>

        <div class="skills-section-header">
          <div class="section-title" style="margin: 0;">æ‰€æœ‰æ–¹æ¡ˆ</div>
          <button class="btn btn-primary" onclick="showAddModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-right: 4px;">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            æ–°å¢æ–¹æ¡ˆ
          </button>
        </div>

        <div id="profileList" class="profile-list">
          <div class="empty-state">åŠ è½½ä¸­...</div>
        </div>
      </div>

      <!-- Skillsç®¡ç†æ ‡ç­¾é¡µ -->
      <div class="tab-content" id="tab-skills">
        <div class="page-header">
          <h2 class="page-title">Skills</h2>
          <p class="page-desc">æ‰©å±• Claude çš„èƒ½åŠ›ï¼Œæ”¯æŒæ–‡æ¡£å¤„ç†ç­‰é«˜çº§åŠŸèƒ½</p>
        </div>

        <div class="skills-intro-card">
          <div class="skills-intro-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            ä»€ä¹ˆæ˜¯ Skillsï¼Ÿ
          </div>
          <div class="skills-intro-text">
            Skills æ˜¯ Claude çš„å®˜æ–¹åŠŸèƒ½æ‰©å±•ã€‚å®‰è£…åå¯ä»¥è®© Claude å¸®ä½ å¤„ç† PDFã€Wordã€PPT ç­‰æ–‡ä»¶ï¼Œæˆ–ä½¿ç”¨å„ç§ç¤ºä¾‹æŠ€èƒ½æå‡æ•ˆç‡ã€‚
          </div>
        </div>

        <div class="skills-section-header">
          <div class="section-title" style="margin: 0;">Skills Marketplace</div>
          <button class="btn btn-primary" onclick="loadSkillsStatus()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-right: 6px;">
              <path d="M23 4v6h-6"></path>
              <path d="M1 20v-6h6"></path>
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            åˆ·æ–°çŠ¶æ€
          </button>
        </div>

        <div class="profile-list">
          <!-- Marketplace -->
          <div class="skill-card">
            <div class="skill-header">
              <div class="skill-info">
                 <div class="skill-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <circle cx="12" cy="12" r="10"></circle>
                      <line x1="2" y1="12" x2="22" y2="12"></line>
                      <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                 </div>
                 <div>
                    <div class="skill-name">Marketplace</div>
                    <div class="skill-desc">æ·»åŠ  anthropics/skills æ’ä»¶å¸‚åœºï¼ˆå¿…é¡»å…ˆå®‰è£…æ‰èƒ½ä½¿ç”¨ä¸‹æ–¹çš„ skillsï¼‰</div>
                 </div>
              </div>
              <div class="profile-actions">
                <span id="status-marketplace" class="skill-status-badge not-installed">æœªå®‰è£…</span>
                <button class="btn btn-secondary" onclick="installSkills('marketplace')" id="btn-install-marketplace">æ·»åŠ </button>
                <button class="btn btn-danger-ghost" onclick="uninstallSkills('marketplace')" id="btn-uninstall-marketplace" style="display: none;">å¸è½½</button>
              </div>
            </div>
          </div>
        </div>

        <div class="skills-section-header" style="margin-top: 32px;">
          <div class="section-title" style="margin: 0;">
            å¯ç”¨çš„ Plugins
            <span id="plugins-count-badge" style="font-size: 12px; color: var(--text-secondary); font-weight: 400; margin-left: 8px;"></span>
          </div>
        </div>

        <div id="plugins-list" class="profile-list">
          <div class="empty-state">è¯·å…ˆå®‰è£… Marketplace</div>
        </div>
      </div>

      <!-- MCP Servers æ ‡ç­¾é¡µ -->
      <div class="tab-content" id="tab-mcp">
        <div class="page-header">
          <h2 class="page-title">MCP</h2>
          <p class="page-desc">ç®¡ç† Claude Desktop çš„ MCP æœåŠ¡å™¨é…ç½®</p>
        </div>

        <div class="skills-section-header">
          <div class="section-title" style="margin: 0;">å·²é…ç½® Servers</div>
          <button class="btn btn-primary" onclick="showAddMcpModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-right: 4px;">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            æ·»åŠ  Server
          </button>
        </div>

        <div id="mcpList" class="profile-list">
          <div class="empty-state">åŠ è½½ä¸­...</div>
        </div>
      </div>

      <!-- Tokenç»Ÿè®¡æ ‡ç­¾é¡µ -->
      <div class="tab-content" id="tab-stats">
        <div class="page-header">
          <h2 class="page-title">Token ç»Ÿè®¡</h2>
          <p class="page-desc">ç›‘æ§å„æ¨¡å‹å’Œæ–¹æ¡ˆçš„ Token ä½¿ç”¨é‡</p>
        </div>

        <div class="stats-summary">
          <div class="stat-card">
            <div class="stat-label">æ€»è¯·æ±‚æ¬¡æ•°</div>
            <div class="stat-value" id="totalRequests">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">è¾“å…¥Token</div>
            <div class="stat-value" id="totalInputTokens">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">è¾“å‡ºToken</div>
            <div class="stat-value" id="totalOutputTokens">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">æ€»Token</div>
            <div class="stat-value" id="totalTokens">-</div>
          </div>
        </div>

        <div class="section-title">
          è¯¦ç»†è®°å½•
          <button class="btn btn-danger-ghost" onclick="clearAllStats()" style="font-size: 13px;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-right: 4px;">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            æ¸…ç©ºç»Ÿè®¡
          </button>
        </div>

        <div class="stats-table-wrapper">
          <table class="stats-table">
            <thead>
              <tr>
                <th>APIæ–¹æ¡ˆ</th>
                <th>æ¨¡å‹</th>
                <th>è¯·æ±‚æ¬¡æ•°</th>
                <th>è¾“å…¥Token</th>
                <th>è¾“å‡ºToken</th>
                <th>æ€»Token</th>
                <th>æœ€åä½¿ç”¨</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="statsTableBody">
              <tr>
                <td colspan="8" class="empty-stats">åŠ è½½ä¸­...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- æ–°å¢/ç¼–è¾‘å¼¹çª— -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <h2 id="modalTitle">æ–°å¢é…ç½®æ–¹æ¡ˆ</h2>
      <form id="profileForm">
        <input type="hidden" id="editId" value="">

        <div class="form-group">
          <label for="name">æ–¹æ¡ˆåç§° *</label>
          <input type="text" id="name" placeholder="ä¾‹å¦‚ï¼šæ™ºè°± GLM-4.7" required>
        </div>

        <div class="form-group">
          <label for="apiUrl">API URL *</label>
          <input type="url" id="apiUrl" placeholder="https://api.qnaigc.com" required>
        </div>

        <div class="form-group">
          <label for="apiKey">API Key *</label>
          <input type="password" id="apiKey" placeholder="sk-..." required>
          <div class="form-hint">æ”¯æŒ OpenAI æ ¼å¼å’Œ Anthropic æ ¼å¼</div>
        </div>

        <div class="form-group">
          <label for="modelName">æ¨¡å‹åç§° *</label>
          <input type="text" id="modelName" placeholder="z-ai/glm-4.7" required>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="hideModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MCP Server æ–°å¢å¼¹çª— -->
  <div class="modal-overlay" id="mcpModal">
    <div class="modal">
      <h2>æ·»åŠ  MCP Server</h2>
      <form id="mcpForm">
        <input type="hidden" id="editMcpName" value="">
        <div class="form-group">
          <label for="mcpName">Server åç§° *</label>
          <input type="text" id="mcpName" placeholder="ä¾‹å¦‚ï¼šfilesystem" required>
        </div>

        <!-- ä¼ è¾“ç±»å‹é€‰æ‹© -->
        <div class="form-group">
          <label style="margin-bottom: 12px;">ä¼ è¾“ç±»å‹</label>
          <div style="display: flex; gap: 20px;">
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: normal;">
              <input type="radio" name="mcpType" value="stdio" checked onchange="toggleMcpType()">
              Local (stdio)
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: normal;">
              <input type="radio" name="mcpType" value="sse" onchange="toggleMcpType()">
              Remote (SSE)
            </label>
          </div>
        </div>

        <!-- Stdio Fields -->
        <div id="stdioFields">
          <div class="form-group">
            <label for="mcpCommand">å¯åŠ¨å‘½ä»¤ *</label>
            <div style="display: flex; gap: 10px;">
              <input type="text" id="mcpCommand" placeholder="ä¾‹å¦‚ï¼šnpx">
              <button type="button" class="btn btn-secondary" onclick="testCommand()" title="æµ‹è¯•å‘½ä»¤èƒ½å¦å¯åŠ¨">
                æµ‹è¯•
              </button>
            </div>
          </div>

          <div class="form-group">
            <label for="mcpArgs">å‚æ•° (æ¯è¡Œä¸€ä¸ª)</label>
            <textarea id="mcpArgs" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--bg-secondary); color: var(--text-primary); min-height: 80px;" placeholder="-y&#10;@modelcontextprotocol/server-filesystem&#10;/Users/username/Desktop"></textarea>
          </div>

          <div class="form-group">
            <label>ç¯å¢ƒå˜é‡</label>
            <div id="envVarsContainer" style="margin-bottom: 10px;">
              <!-- åŠ¨æ€æ’å…¥ -->
            </div>
            <button type="button" class="btn btn-secondary" style="width: 100%; font-size: 13px;" onclick="addEnvVarRow()">
              + æ·»åŠ å˜é‡
            </button>
          </div>
        </div>

        <!-- SSE Fields -->
        <div id="sseFields" style="display: none;">
          <div class="form-group">
            <label for="mcpUrl">Server URL *</label>
            <input type="url" id="mcpUrl" placeholder="http://localhost:8000/sse">
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="hideMcpModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- é€šçŸ¥ -->
  <div class="notification" id="notification"></div>

  <script>
    // çŠ¶æ€ç®¡ç†
    let config = { profiles: [], activeProfile: null };
    let isInstalled = false;
    let tokenStats = { records: [] };
    let currentTab = 'profiles';
    let skillsStatus = { marketplaceAdded: false, plugins: [] };
    let availableSkills = [];
    let enabledSkills = [];
    let mcpServersList = [];

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName) {
      currentTab = tabName;

      // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.nav-item').forEach(btn => {
        btn.classList.remove('active');
      });
      event.currentTarget.classList.add('active');

      // æ›´æ–°å†…å®¹åŒºåŸŸæ˜¾ç¤º
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`tab-${tabName}`).classList.add('active');

      // åˆ‡æ¢åˆ°ç»Ÿè®¡æ ‡ç­¾æ—¶é‡æ–°åŠ è½½æ•°æ®
      if (tabName === 'stats') {
        loadTokenStats();
      }
      // åˆ‡æ¢åˆ°Skillsæ ‡ç­¾æ—¶åŠ è½½çŠ¶æ€
      if (tabName === 'skills') {
        loadSkillsStatus();
      }
      // åˆ‡æ¢åˆ°MCPæ ‡ç­¾æ—¶åŠ è½½æ•°æ®
      if (tabName === 'mcp') {
        loadMcpServers();
      }
    }

    // åŠ è½½ MCP Servers
    async function loadMcpServers() {
      try {
        const res = await fetch('/api/mcp/servers');
        const data = await res.json();
        mcpServersList = data.servers || [];
        renderMcpList(mcpServersList);
      } catch (error) {
        console.error('åŠ è½½ MCP Servers å¤±è´¥', error);
        showNotification('åŠ è½½ MCP Servers å¤±è´¥', 'error');
      }
    }

    // æ¸²æŸ“ MCP åˆ—è¡¨
    function renderMcpList(servers) {
      const listEl = document.getElementById('mcpList');
      if (!listEl) return;

      if (servers.length === 0) {
        listEl.innerHTML = '<div class="empty-state">æš‚æ—  MCP Server é…ç½®</div>';
        return;
      }

      listEl.innerHTML = servers.map(server => {
        let details = '';
        let badge = '';

        if (server.url) {
            // SSE Type
            badge = '<span class="skill-status-badge installed" style="background: var(--bg-tertiary); color: var(--text-primary);">Remote (SSE)</span>';
            details = `<div class="skill-desc" style="font-family: monospace; font-size: 12px; margin-top: 4px;">${escapeHtml(server.url)}</div>`;
        } else {
            // Stdio Type
            badge = '<span class="skill-status-badge installed" style="background: var(--bg-tertiary); color: var(--text-primary);">Local (stdio)</span>';
            details = `<div class="skill-desc" style="font-family: monospace; font-size: 12px; margin-top: 4px;">
                  ${escapeHtml(server.command || '')} ${(server.args || []).join(' ')}
                </div>`;
        }

        return `
        <div class="skill-card">
          <div class="skill-header">
            <div class="skill-info">
              <div class="skill-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                   <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
              </div>
              <div>
                <div class="skill-name" style="display: flex; align-items: center; gap: 8px;">
                    ${escapeHtml(server.name)}
                    ${badge}
                </div>
                ${details}
              </div>
            </div>
            <div class="profile-actions">
              <button class="btn btn-edit btn-icon-only" onclick="showEditMcpModal('${escapeHtml(server.name)}')" title="Edit">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
              <button class="btn btn-danger-ghost" onclick="deleteMcpServer('${server.name}')">åˆ é™¤</button>
            </div>
          </div>
        </div>
      `;
      }).join('');
    }

    // å¼¹çª—æ§åˆ¶ - MCP
    function showAddMcpModal() {
      document.getElementById('editMcpName').value = '';
      document.querySelector('#mcpModal h2').textContent = 'Add MCP Server';
      document.getElementById('mcpName').value = '';
      document.getElementById('mcpCommand').value = '';
      document.getElementById('mcpArgs').value = '';
      document.getElementById('mcpUrl').value = '';
      document.getElementById('envVarsContainer').innerHTML = ''; // Clear env vars

      // Reset to default Stdio
      document.querySelector('input[name="mcpType"][value="stdio"]').checked = true;
      toggleMcpType();

      document.getElementById('mcpModal').classList.add('show');
    }

    function showEditMcpModal(name) {
      const server = mcpServersList.find(s => s.name === name);
      if (!server) return;

      // Set hidden field
      document.getElementById('editMcpName').value = name;
      document.getElementById('mcpName').value = server.name;

      // Handle Type
      const type = server.url ? 'sse' : 'stdio';
      document.querySelector(`input[name="mcpType"][value="${type}"]`).checked = true;
      toggleMcpType(); // Refresh UI visibility

      // Populate fields based on type
      if (type === 'sse') {
        document.getElementById('mcpUrl').value = server.url;
      } else {
        document.getElementById('mcpCommand').value = server.command;
        document.getElementById('mcpArgs').value = (server.args || []).join('\n');

        // Populate Env Vars
        const container = document.getElementById('envVarsContainer');
        container.innerHTML = ''; // Clear existing
        if (server.env) {
          Object.entries(server.env).forEach(([key, value]) => {
            addEnvVarRow(key, value);
          });
        }
      }

      // Update Modal Title
      document.querySelector('#mcpModal h2').textContent = 'Edit MCP Server';

      document.getElementById('mcpModal').classList.add('show');
    }

    function hideMcpModal() {
      document.getElementById('mcpModal').classList.remove('show');
    }

    // Toggle MCP Type
    function toggleMcpType() {
      const type = document.querySelector('input[name="mcpType"]:checked').value;
      const stdioFields = document.getElementById('stdioFields');
      const sseFields = document.getElementById('sseFields');

      if (type === 'stdio') {
        stdioFields.style.display = 'block';
        sseFields.style.display = 'none';
        document.getElementById('mcpCommand').required = true;
        document.getElementById('mcpUrl').required = false;
      } else {
        stdioFields.style.display = 'none';
        sseFields.style.display = 'block';
        document.getElementById('mcpCommand').required = false;
        document.getElementById('mcpUrl').required = true;
      }
    }

    // Dynamic Env Vars Logic
    function addEnvVarRow(key = '', value = '') {
        const container = document.getElementById('envVarsContainer');
        const id = Date.now();
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.gap = '8px';
        row.style.marginBottom = '8px';
        row.innerHTML = `
            <input type="text" placeholder="KEY" class="env-key" value="${escapeHtml(key)}" style="flex: 1; min-width: 0;">
            <input type="text" placeholder="VALUE" class="env-value" value="${escapeHtml(value)}" style="flex: 2; min-width: 0;">
            <button type="button" class="btn btn-danger-ghost btn-icon-only" onclick="this.parentElement.remove()" tabindex="-1">âœ•</button>
        `;
        container.appendChild(row);
    }

    // Test Command Logic
    async function testCommand() {
        const command = document.getElementById('mcpCommand').value.trim();
        const argsText = document.getElementById('mcpArgs').value.trim();
        const args = argsText ? argsText.split('\n').filter(line => line.trim()) : [];

        if (!command) {
            showNotification('è¯·è¾“å…¥å¯åŠ¨å‘½ä»¤', 'error');
            return;
        }

        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/mcp/test-command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command, args })
            });
            const data = await res.json();

            if (data.success) {
                showNotification('æµ‹è¯•é€šè¿‡ï¼šå‘½ä»¤å¯æ‰§è¡Œ', 'success');
            } else {
                showNotification('æµ‹è¯•å¤±è´¥ï¼š' + (data.error || 'æ— æ³•æ‰§è¡Œå‘½ä»¤'), 'error');
            }
        } catch (error) {
             showNotification('è¯·æ±‚å¤±è´¥', 'error');
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }


    // MCP è¡¨å•æäº¤
    document.getElementById('mcpForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const type = document.querySelector('input[name="mcpType"]:checked').value;
      const name = document.getElementById('mcpName').value.trim();
      let serverData = { name, type };

      if (type === 'stdio') {
          const command = document.getElementById('mcpCommand').value.trim();
          const argsText = document.getElementById('mcpArgs').value.trim();
          const args = argsText ? argsText.split('\n').filter(line => line.trim()) : [];

          // Collect Env Vars
          const env = {};
          document.querySelectorAll('#envVarsContainer > div').forEach(row => {
              const key = row.querySelector('.env-key').value.trim();
              const value = row.querySelector('.env-value').value.trim();
              if (key) env[key] = value;
          });

          serverData = { ...serverData, command, args, env };
      } else {
          const url = document.getElementById('mcpUrl').value.trim();
          serverData = { ...serverData, url };
      }

      const editMcpName = document.getElementById('editMcpName').value;
      const method = editMcpName ? 'PUT' : 'POST';
      const url = editMcpName
        ? `/api/mcp/servers/${encodeURIComponent(editMcpName)}`
        : '/api/mcp/servers';

      try {
        const res = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(serverData)
        });

        if (res.ok) {
          showNotification('MCP Server ä¿å­˜æˆåŠŸï¼è¯·é‡å¯ Claude Desktop ç”Ÿæ•ˆ', 'success');
          // Add a longer persistent alert or confirm dialog
          alert("é…ç½®å·²ä¿å­˜ã€‚\n\næ³¨æ„ï¼šæ‚¨å¿…é¡»å®Œå…¨é€€å‡ºå¹¶é‡å¯ Claude Desktop åº”ç”¨ï¼Œæ–°é…ç½®æ‰ä¼šç”Ÿæ•ˆã€‚");

          hideMcpModal();
          loadMcpServers();
        } else {
          const data = await res.json();
          showNotification(data.error || 'ä¿å­˜å¤±è´¥', 'error');
        }
      } catch (error) {
        showNotification('ä¿å­˜å¤±è´¥', 'error');
      }
    });

    // åˆ é™¤ MCP Server
    async function deleteMcpServer(name) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ MCP Server "${name}" å—ï¼Ÿ`)) return;

      try {
        const res = await fetch(`/api/mcp/servers/${name}`, { method: 'DELETE' });
        if (res.ok) {
          showNotification('åˆ é™¤æˆåŠŸ', 'success');
          loadMcpServers();
        } else {
          showNotification('åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        showNotification('åˆ é™¤å¤±è´¥', 'error');
      }
    }

    // ========== é…ç½®çŠ¶æ€æ£€æµ‹ç›¸å…³å‡½æ•° ==========

    // æ£€æµ‹é…ç½®çŠ¶æ€
    async function checkConfigStatus() {
      const contentEl = document.getElementById('configStatusContent');
      contentEl.innerHTML = '<div class="status-loading">æ£€æµ‹ä¸­...</div>';

      try {
        const res = await fetch('/api/config/conflicts');
        const data = await res.json();

        if (data.hasConflicts) {
          const errors = data.conflicts.filter(c => c.severity === 'error');
          const warnings = data.conflicts.filter(c => c.severity === 'warning');

          let html = '';

          if (errors.length > 0) {
            html += `
              <div class="conflict-error">
                <div class="conflict-header">
                  <div class="conflict-icon">âš ï¸</div>
                  <div class="conflict-title">å‘ç°é…ç½®å†²çª</div>
                </div>
                <div class="conflict-message">${escapeHtml(errors[0].message)}</div>
                ${errors[0].lines ? `<pre class="conflict-code">${escapeHtml(errors[0].lines.join('\n'))}</pre>` : ''}
                ${errors[0].recommendation ? `<div class="conflict-message" style="margin-top: 8px;">ğŸ’¡ ${escapeHtml(errors[0].recommendation)}</div>` : ''}
                <button class="btn btn-primary" onclick="fixConflicts()" style="margin-top: 8px;">
                  ä¸€é”®ä¿®å¤
                </button>
              </div>
            `;
          }

          if (warnings.length > 0) {
            html += `
              <div class="conflict-warning">
                <div class="conflict-header">
                  <div class="conflict-icon">â„¹ï¸</div>
                  <div class="conflict-title">æ³¨æ„äº‹é¡¹</div>
                </div>
                <div class="conflict-message">${escapeHtml(warnings[0].message)}</div>
              </div>
            `;
          }

          contentEl.innerHTML = html;
        } else {
          contentEl.innerHTML = `
            <div class="status-ok">
              <div class="status-icon">âœ“</div>
              <div class="status-message">é…ç½®çŠ¶æ€æ­£å¸¸ï¼Œæœªå‘ç°å†²çª</div>
            </div>
          `;
        }
      } catch (error) {
        contentEl.innerHTML = `
          <div class="conflict-warning">
            <div class="conflict-message">æ£€æµ‹å¤±è´¥: ${escapeHtml(error.message)}</div>
          </div>
        `;
      }
    }

    // ä¸€é”®ä¿®å¤é…ç½®å†²çª
    async function fixConflicts() {
      if (!confirm('ç¡®å®šè¦è‡ªåŠ¨ä¿®å¤é…ç½®å†²çªå—ï¼Ÿ\n\nè¿™å°†ä¿®æ”¹ .zshrc æ–‡ä»¶ï¼Œç§»é™¤ç¡¬ç¼–ç çš„ ANTHROPIC_* é…ç½®ã€‚')) return;

      try {
        const res = await fetch('/api/config/fix-conflicts', { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          showNotification(data.message, 'success');

          if (data.requiresRestart) {
            document.getElementById('restartTip').style.display = 'block';
          }

          // é‡æ–°æ£€æµ‹çŠ¶æ€
          await checkConfigStatus();
        } else {
          showNotification(data.error || 'ä¿®å¤å¤±è´¥', 'error');
        }
      } catch (error) {
        showNotification('ä¿®å¤å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æµ‹è¯• API è¿æ¥
    async function testProfile(id) {
      const btn = event.target;
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<span style="animation: spin 1s linear inline-block">âŸ³</span> æµ‹è¯•ä¸­...';
      btn.disabled = true;

      try {
        const res = await fetch(`/api/profiles/${id}/test`, { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          showNotification(`è¿æ¥æˆåŠŸï¼æ¨¡å‹: ${data.model}ï¼Œå»¶è¿Ÿ: ${data.latency}ms`, 'success');
        } else {
          showNotification(`è¿æ¥å¤±è´¥: ${data.error}`, 'error');
        }
      } catch (error) {
        showNotification('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
      } finally {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
      }
    }

    // ========== åŸæœ‰åŠŸèƒ½ ==========

    // åŠ è½½é…ç½®
    async function loadConfig() {
      try {
        const [configRes, setupRes] = await Promise.all([
          fetch('/api/config'),
          fetch('/api/check-setup')
        ]);
        config = await configRes.json();
        const setupData = await setupRes.json();
        isInstalled = setupData.isInstalled;
        render();
      } catch (error) {
        showNotification('åŠ è½½é…ç½®å¤±è´¥', 'error');
      }
    }

    // åŠ è½½tokenç»Ÿè®¡
    async function loadTokenStats() {
      try {
        const res = await fetch('/api/token-stats');
        const data = await res.json();
        tokenStats = data;
        renderStats();
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥', error);
      }
    }

    // åŠ è½½SkillsçŠ¶æ€
    async function loadSkillsStatus() {
      // æŸ¥æ‰¾åˆ·æ–°æŒ‰é’®ï¼ˆå¦‚æœæ˜¯ä»æŒ‰é’®ç‚¹å‡»è§¦å‘ï¼‰
      const refreshBtn = event?.target?.closest('button');
      const originalHTML = refreshBtn?.innerHTML;

      try {
        if (refreshBtn) {
          refreshBtn.disabled = true;
          refreshBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-right: 6px; animation: spin 1s linear infinite;"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>åˆ·æ–°ä¸­...';
        }

        const res = await fetch('/api/skills/status');
        const data = await res.json();
        skillsStatus = data;

        // åŠ è½½å¯ç”¨çš„ skills åˆ—è¡¨
        await loadAvailableSkills();

        renderSkillsStatus();

        if (refreshBtn) {
          showNotification('çŠ¶æ€å·²åˆ·æ–°', 'success');
        }
      } catch (error) {
        console.error('åŠ è½½SkillsçŠ¶æ€å¤±è´¥', error);
        showNotification('åˆ·æ–°å¤±è´¥', 'error');
      } finally {
        if (refreshBtn && originalHTML) {
          refreshBtn.disabled = false;
          refreshBtn.innerHTML = originalHTML;
        }
      }
    }

    // åŠ è½½å¯ç”¨çš„ skills åˆ—è¡¨
    async function loadAvailableSkills() {
      try {
        const res = await fetch('/api/skills/available');
        const data = await res.json();
        availableSkills = data.available || [];
        enabledSkills = data.enabled || [];
        renderSkillsList();
      } catch (error) {
        console.error('åŠ è½½å¯ç”¨Skillså¤±è´¥', error);
        availableSkills = [];
        enabledSkills = [];
      }
    }

    // æ¸²æŸ“SkillsçŠ¶æ€
    function renderSkillsStatus() {
      const { marketplaceAdded } = skillsStatus;

      // æ›´æ–°marketplaceçŠ¶æ€
      const marketStatus = document.getElementById('status-marketplace');
      const installMarketBtn = document.getElementById('btn-install-marketplace');
      const uninstallMarketBtn = document.getElementById('btn-uninstall-marketplace');

      if (marketStatus) {
        if (marketplaceAdded) {
          marketStatus.textContent = 'å·²æ·»åŠ ';
          marketStatus.classList.remove('not-installed');
          marketStatus.classList.add('installed');
          marketStatus.style.background = 'var(--success-bg)';
          marketStatus.style.color = 'var(--success)';
          if (installMarketBtn) installMarketBtn.style.display = 'none';
          if (uninstallMarketBtn) uninstallMarketBtn.style.display = 'inline-flex';
        } else {
          marketStatus.textContent = 'æœªå®‰è£…';
          marketStatus.classList.remove('installed');
          marketStatus.classList.add('not-installed');
          marketStatus.style.background = 'var(--warning-bg)';
          marketStatus.style.color = 'var(--warning)';
          if (installMarketBtn) installMarketBtn.style.display = 'inline-flex';
          if (uninstallMarketBtn) uninstallMarketBtn.style.display = 'none';
        }
      }
    }

    // æ¸²æŸ“ Skills åˆ—è¡¨
    function renderSkillsList() {
      const skillsList = document.getElementById('plugins-list'); // Changed from skills-list
      const countBadge = document.getElementById('plugins-count-badge'); // Changed from skills-count-badge
      const enableAllBtn = document.getElementById('btn-enable-all');

      if (!skillsStatus.marketplaceAdded || availableSkills.length === 0) {
        if (skillsList) skillsList.innerHTML = '<div class="empty-state">è¯·å…ˆå®‰è£… Marketplace</div>';
        if (countBadge) countBadge.textContent = '';
        if (enableAllBtn) enableAllBtn.style.display = 'none';
        return;
      }

      // æ›´æ–°è®¡æ•°
      const enabledCount = enabledSkills.length;
      const totalCount = availableSkills.length;
      if (countBadge) countBadge.textContent = `å·²å¯ç”¨ ${enabledCount}/${totalCount}`;

      // æ˜¾ç¤º/éšè—å…¨éƒ¨å¯ç”¨æŒ‰é’®
      if (enableAllBtn) {
        enableAllBtn.style.display = enabledCount < totalCount ? 'inline-flex' : 'none';
      }

      if (!skillsList) return;

      // æ¸²æŸ“ skills å¡ç‰‡
      skillsList.innerHTML = availableSkills.map(skill => {
        const isEnabled = enabledSkills.includes(skill.id);
        return `
          <div class="skill-card">
            <div class="skill-header">
              <div class="skill-info">
                <div class="skill-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                  </svg>
                </div>
                <div>
                  <div class="skill-name">${escapeHtml(skill.name)}</div>
                  <div class="skill-desc">${escapeHtml(skill.description || skill.id)}</div>
                </div>
              </div>
              <div class="profile-actions">
                <span class="skill-status-badge ${isEnabled ? 'installed' : 'not-installed'}" style="background: ${isEnabled ? 'var(--success-bg)' : 'var(--warning-bg)'}; color: ${isEnabled ? 'var(--success)' : 'var(--warning)'};">
                  ${isEnabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}
                </span>
                <button class="btn ${isEnabled ? 'btn-danger-ghost' : 'btn-primary'}" onclick="toggleSkill('${skill.id}')">
                  ${isEnabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // å®‰è£…Skills
    async function installSkills(type) {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = type === 'marketplace' || type === 'all' ? 'æ­£åœ¨ä¸‹è½½...' : 'éªŒè¯ä¸­...';
      btn.disabled = true;

      try {
        // å¯¹äº marketplace å®‰è£…ï¼Œè®¾ç½®è¾ƒé•¿çš„è¶…æ—¶æ—¶é—´ï¼ˆ3åˆ†é’Ÿï¼‰
        const timeout = (type === 'marketplace' || type === 'all') ? 180000 : 30000;

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);

        const res = await fetch('/api/skills/install', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        const data = await res.json();
        if (data.success) {
          // æ£€æŸ¥æ˜¯å¦æœ‰ marketplace å®‰è£…
          const hasMarketplaceInstall = data.results?.some(r =>
            r.type === 'marketplace' && r.message.includes('å®‰è£…æˆåŠŸ')
          );

          if (hasMarketplaceInstall) {
            showNotification('Marketplace å®‰è£…æˆåŠŸï¼æ­£åœ¨åˆ·æ–°çŠ¶æ€...', 'success');
          } else {
            showNotification('æ“ä½œå®Œæˆ', 'success');
          }

          await loadSkillsStatus();
        } else {
          showNotification(data.error || 'æ“ä½œå¤±è´¥', 'error');
          await loadSkillsStatus();
        }
      } catch (error) {
        if (error.name === 'AbortError') {
          // è¶…æ—¶æƒ…å†µ
          if (type === 'marketplace' || type === 'all') {
            showNotification('å®‰è£…æ­£åœ¨åå°è¿›è¡Œï¼Œè¯·ç¨åç‚¹å‡»"åˆ·æ–°çŠ¶æ€"æŸ¥çœ‹', 'info');
            // å¯åŠ¨è½®è¯¢æ£€æŸ¥ï¼ˆæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œæœ€å¤š12æ¬¡=1åˆ†é’Ÿï¼‰
            startPollingStatus(12, 5000);
          } else {
            showNotification('æ“ä½œè¶…æ—¶', 'error');
          }
        } else {
          showNotification('æ“ä½œå¤±è´¥: ' + error.message, 'error');
        }
        await loadSkillsStatus();
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    // è½®è¯¢æ£€æŸ¥å®‰è£…çŠ¶æ€
    let pollingTimer = null;
    function startPollingStatus(maxAttempts, interval) {
      let attempts = 0;

      // æ¸…é™¤ä¹‹å‰çš„è½®è¯¢
      if (pollingTimer) {
        clearInterval(pollingTimer);
      }

      pollingTimer = setInterval(async () => {
        attempts++;

        // é™é»˜åˆ·æ–°çŠ¶æ€ï¼ˆä¸æ˜¾ç¤ºé€šçŸ¥ï¼‰
        try {
          const res = await fetch('/api/skills/status');
          const data = await res.json();
          const oldStatus = skillsStatus.marketplaceAdded;
          skillsStatus = data;
          renderSkillsStatus();

          // å¦‚æœçŠ¶æ€å˜åŒ–äº†ï¼Œè¯´æ˜å®‰è£…å®Œæˆ
          if (!oldStatus && data.marketplaceAdded) {
            showNotification('Marketplace å®‰è£…å®Œæˆï¼', 'success');
            clearInterval(pollingTimer);
            pollingTimer = null;
          }
        } catch (error) {
          console.error('è½®è¯¢çŠ¶æ€å¤±è´¥', error);
        }

        // è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°ååœæ­¢
        if (attempts >= maxAttempts) {
          clearInterval(pollingTimer);
          pollingTimer = null;
        }
      }, interval);
    }

    // å¸è½½Skills
    async function uninstallSkills(type) {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = 'å¸è½½ä¸­...';
      btn.disabled = true;

      try {
        const res = await fetch('/api/skills/uninstall', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type })
        });

        const data = await res.json();
        if (data.success) {
          showNotification('å¸è½½å®Œæˆ', 'success');
          await loadSkillsStatus();
        } else {
          showNotification(data.error || 'å¸è½½å¤±è´¥', 'error');
        }
      } catch (error) {
        showNotification('å¸è½½å¤±è´¥', 'error');
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    // åˆ‡æ¢ skill çš„å¯ç”¨/ç¦ç”¨çŠ¶æ€
    async function toggleSkill(skillId) {
      const isEnabled = enabledSkills.includes(skillId);
      const endpoint = isEnabled ? '/api/skills/disable' : '/api/skills/enable';

      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ skillId })
        });

        const data = await res.json();
        if (data.success) {
          enabledSkills = data.enabled;
          renderSkillsList();
          showNotification(isEnabled ? 'Skill å·²ç¦ç”¨' : 'Skill å·²å¯ç”¨', 'success');
        } else {
          showNotification('æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        showNotification('æ“ä½œå¤±è´¥: ' + error.message, 'error');
      }
    }

    // å…¨éƒ¨å¯ç”¨
    async function enableAllSkills() {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = 'å¯ç”¨ä¸­...';
      btn.disabled = true;

      try {
        let successCount = 0;
        for (const skill of availableSkills) {
          if (!enabledSkills.includes(skill.id)) {
            const res = await fetch('/api/skills/enable', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ skillId: skill.id })
            });

            const data = await res.json();
            if (data.success) {
              enabledSkills = data.enabled;
              successCount++;
            }
          }
        }

        renderSkillsList();
        showNotification(`å·²å¯ç”¨ ${successCount} ä¸ª Skills`, 'success');
      } catch (error) {
        showNotification('æ‰¹é‡å¯ç”¨å¤±è´¥', 'error');
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    // æ¸²æŸ“
    function render() {
      // éšè—æ‰€æœ‰æç¤º
      document.getElementById('reloadTip').style.display = 'none';
      document.getElementById('setupTip').style.display = 'none';

      // æ˜¾ç¤ºå®‰è£…æç¤ºï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
      if (!isInstalled) {
        document.getElementById('setupTip').style.display = 'block';
      }
      // æ›´æ–°å½“å‰çŠ¶æ€
      const statusEl = document.getElementById('currentStatus');
      const statusDot = document.getElementById('statusDot');
      const activeProfile = config.profiles.find(p => p.id === config.activeProfile);

      if (activeProfile) {
        statusEl.textContent = activeProfile.name;
        statusDot.className = 'status-dot';
      } else {
        statusEl.textContent = 'æœªæ¿€æ´»ä»»ä½•æ–¹æ¡ˆ';
        statusDot.className = 'status-dot inactive';
      }

      // æ¸²æŸ“æ–¹æ¡ˆåˆ—è¡¨
      const listEl = document.getElementById('profileList');
      if (config.profiles.length === 0) {
        listEl.innerHTML = '<div class="empty-state">æš‚æ— é…ç½®æ–¹æ¡ˆï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>';
        return;
      }

      listEl.innerHTML = config.profiles.map(p => `
        <div class="profile-card ${p.id === config.activeProfile ? 'active' : ''}">
          <div class="profile-header">
            <div class="profile-name">
              ${escapeHtml(p.name)}
              <span class="profile-model">
                ${escapeHtml(p.modelName || 'æœªçŸ¥æ¨¡å‹')}
              </span>
            </div>
            <div class="profile-actions">
              ${p.id !== config.activeProfile ? `
              <button class="btn btn-secondary" onclick="activateProfile('${p.id}')">
                æ¿€æ´»
              </button>` : `
              <button class="btn btn-primary" disabled style="opacity: 1; cursor: default;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-right: 4px;">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                å·²æ¿€æ´»
              </button>`
              }
              <button class="btn btn-secondary" onclick="testProfile('${p.id}')" title="æµ‹è¯•è¿æ¥">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
              </button>
              <button class="btn btn-edit btn-icon-only" onclick="showEditModal('${p.id}')" title="ç¼–è¾‘">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
              <button class="btn btn-danger-ghost btn-icon-only" onclick="deleteProfile('${p.id}')" title="åˆ é™¤">
                 <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // æ¸²æŸ“tokenç»Ÿè®¡
    function renderStats() {
      const records = tokenStats.records || [];

      // è®¡ç®—æ€»è®¡
      const totalRequests = records.reduce((sum, r) => sum + r.requestCount, 0);
      const totalInputTokens = records.reduce((sum, r) => sum + r.inputTokens, 0);
      const totalOutputTokens = records.reduce((sum, r) => sum + r.outputTokens, 0);
      const totalTokens = totalInputTokens + totalOutputTokens;

      // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
      document.getElementById('totalRequests').textContent = formatNumber(totalRequests);
      document.getElementById('totalInputTokens').textContent = formatNumber(totalInputTokens);
      document.getElementById('totalOutputTokens').textContent = formatNumber(totalOutputTokens);
      document.getElementById('totalTokens').textContent = formatNumber(totalTokens);

      // æ¸²æŸ“è¡¨æ ¼
      const tbody = document.getElementById('statsTableBody');
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty-stats">æš‚æ— ä½¿ç”¨è®°å½•</td></tr>';
        return;
      }

      // æŒ‰æœ€åä½¿ç”¨æ—¶é—´æ’åº
      const sortedRecords = [...records].sort((a, b) =>
        new Date(b.lastUsedAt) - new Date(a.lastUsedAt)
      );

      tbody.innerHTML = sortedRecords.map(r => `
        <tr>
          <td><strong>${escapeHtml(r.profileName)}</strong></td>
          <td><span class="model-badge">${escapeHtml(r.modelName)}</span></td>
          <td class="token-number">${r.requestCount}</td>
          <td class="token-number token-input">${formatNumber(r.inputTokens)}</td>
          <td class="token-number token-output">${formatNumber(r.outputTokens)}</td>
          <td class="token-number token-total">${formatNumber(r.totalTokens)}</td>
          <td style="font-size: 13px; color: var(--text-secondary);">${formatDate(r.lastUsedAt)}</td>
          <td>
            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteStatRecord('${r.id}')">åˆ é™¤</button>
          </td>
        </tr>
      `).join('');
    }

    // åˆ é™¤ç»Ÿè®¡è®°å½•
    async function deleteStatRecord(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç»Ÿè®¡è®°å½•å—ï¼Ÿ')) return;

      try {
        const res = await fetch(`/api/token-stats/${id}`, { method: 'DELETE' });
        if (res.ok) {
          showNotification('åˆ é™¤æˆåŠŸ', 'success');
          await loadTokenStats();
        } else {
          showNotification('åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        showNotification('åˆ é™¤å¤±è´¥', 'error');
      }
    }

    // æ¸…ç©ºæ‰€æœ‰ç»Ÿè®¡
    async function clearAllStats() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç»Ÿè®¡æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

      try {
        const res = await fetch('/api/token-stats', { method: 'DELETE' });
        if (res.ok) {
          showNotification('å·²æ¸…ç©ºæ‰€æœ‰ç»Ÿè®¡', 'success');
          await loadTokenStats();
        } else {
          showNotification('æ¸…ç©ºå¤±è´¥', 'error');
        }
      } catch (error) {
        showNotification('æ¸…ç©ºå¤±è´¥', 'error');
      }
    }

    // æ ¼å¼åŒ–æ•°å­—
    function formatNumber(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
      }
      if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
      }
      return num.toString();
    }

    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(isoString) {
      const date = new Date(isoString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'åˆšåˆš';
      if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
      if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
      if (diffDays < 7) return `${diffDays}å¤©å‰`;

      return date.toLocaleDateString('zh-CN', {
        month: 'short',
        day: 'numeric'
      });
    }

    // æ–°å¢æ–¹æ¡ˆ
    async function addProfile(profile) {
      try {
        const res = await fetch('/api/profiles', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(profile)
        });

        if (res.ok) {
          showNotification('æ·»åŠ æˆåŠŸ', 'success');
          await loadConfig();
          hideModal();
        } else {
          const data = await res.json();
          showNotification(data.error || 'æ·»åŠ å¤±è´¥', 'error');
        }
      } catch (error) {
        showNotification('æ·»åŠ å¤±è´¥', 'error');
      }
    }

    // æ›´æ–°æ–¹æ¡ˆ
    async function updateProfile(id, profile) {
      try {
        const res = await fetch(`/api/profiles/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(profile)
        });

        if (res.ok) {
          showNotification('ä¿å­˜æˆåŠŸ', 'success');
          await loadConfig();
          hideModal();
        } else {
          const data = await res.json();
          showNotification(data.error || 'ä¿å­˜å¤±è´¥', 'error');
        }
      } catch (error) {
        showNotification('ä¿å­˜å¤±è´¥', 'error');
      }
    }

    // åˆ é™¤æ–¹æ¡ˆ
    async function deleteProfile(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–¹æ¡ˆå—ï¼Ÿ')) return;

      try {
        const res = await fetch(`/api/profiles/${id}`, { method: 'DELETE' });
        if (res.ok) {
          showNotification('åˆ é™¤æˆåŠŸ', 'success');
          await loadConfig();
        } else {
          showNotification('åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        showNotification('åˆ é™¤å¤±è´¥', 'error');
      }
    }

    // æ¿€æ´»æ–¹æ¡ˆ
    async function activateProfile(id) {
      try {
        const res = await fetch(`/api/profiles/${id}/activate`, {
          method: 'POST'
        });

        if (res.ok) {
          const data = await res.json();
          config.activeProfile = id;
          isInstalled = data.isInstalled;
          render();
          showNotification('é…ç½®å·²æ›´æ–°', 'success');

          // å¦‚æœå·²å®‰è£…ï¼Œæ˜¾ç¤ºæˆåŠŸæç¤º
          if (isInstalled) {
            document.getElementById('reloadTip').style.display = 'flex';
          }
        } else {
          showNotification('æ¿€æ´»å¤±è´¥', 'error');
        }
      } catch (error) {
        showNotification('æ¿€æ´»å¤±è´¥', 'error');
      }
    }

    // å¼¹çª—æ§åˆ¶
    function showAddModal() {
      document.getElementById('modalTitle').textContent = 'æ–°å¢é…ç½®æ–¹æ¡ˆ';
      document.getElementById('editId').value = '';
      document.getElementById('name').value = '';
      document.getElementById('apiUrl').value = '';
      document.getElementById('apiKey').value = '';
      document.getElementById('modelName').value = '';
      document.getElementById('modal').classList.add('show');
    }

    function showEditModal(id) {
      const profile = config.profiles.find(p => p.id === id);
      if (!profile) {
        showNotification('æ–¹æ¡ˆä¸å­˜åœ¨', 'error');
        return;
      }
      document.getElementById('modalTitle').textContent = 'ç¼–è¾‘é…ç½®æ–¹æ¡ˆ';
      document.getElementById('editId').value = id;
      document.getElementById('name').value = profile.name;
      document.getElementById('apiUrl').value = profile.apiUrl;
      document.getElementById('apiKey').value = profile.apiKey;
      document.getElementById('modelName').value = profile.modelName;
      document.getElementById('modal').classList.add('show');
    }

    function hideModal() {
      document.getElementById('modal').classList.remove('show');
    }

    // è¡¨å•æäº¤
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const editId = document.getElementById('editId').value;
      const profile = {
        name: document.getElementById('name').value.trim(),
        apiUrl: document.getElementById('apiUrl').value.trim(),
        apiKey: document.getElementById('apiKey').value.trim(),
        modelName: document.getElementById('modelName').value.trim()
      };
      if (editId) {
        await updateProfile(editId, profile);
      } else {
        await addProfile(profile);
      }
    });

    // é€šçŸ¥
    function showNotification(message, type = 'success') {
      const el = document.getElementById('notification');
      el.textContent = message;
      el.className = `notification ${type} show`;
      setTimeout(() => el.classList.remove('show'), 3000);
    }

    // å·¥å…·å‡½æ•°
    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
    }

    function maskKey(key) {
      if (key.length <= 8) return '***';
      return key.substring(0, 4) + '...' + key.substring(key.length - 4);
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target.id === 'modal') hideModal();
    });

    // ESC é”®å…³é—­å¼¹çª—
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') hideModal();
    });

    // åˆå§‹åŒ–
    loadConfig();
    // è‡ªåŠ¨æ£€æµ‹é…ç½®çŠ¶æ€
    checkConfigStatus();
  </script>
</body>
</html>
